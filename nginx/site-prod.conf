# Canonical host
server {
  listen 80;
  server_name app.mydomain.com;
  root /usr/share/nginx/html;
  index index.html;

  # --- Security & SEO headers (prod) ---
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=()" always;

  # Health endpoint (simple static OK)
  location = /health { return 200 "ok"; add_header Content-Type text/plain; }

  # *** Clean-URL option B (no trailing slash): redirect "/path/" -> "/path"
  location ~ ^(.+)/$ {
    return 301 $1$is_args$args;
  }

  # Static assets: long cache, immutable
  location ~* \.(?:css|js|mjs|map|json|png|jpg|jpeg|gif|ico|svg|webp|avif|woff2?|ttf)$ {
    access_log off;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # Sitemaps / robots: short cache
  location ~* ^/(?:sitemap\.xml|robots\.txt)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    try_files $uri =404;
  }

  # HTML & everything else: clean-URL resolution
  # Try the literal file, a ".html" sibling, then an "index.html" under the path
  location / {
    try_files $uri $uri.html $uri/index.html =404;
  }
}

# Non-canonical hosts redirect permanently to prod
server {
  listen 80;
  server_name app-dev.mydomain.com www.app.mydomain.com;
  return 308 http://app.mydomain.com$request_uri;
}
